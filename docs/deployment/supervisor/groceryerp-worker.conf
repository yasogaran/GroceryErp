; ============================================
; Supervisor Configuration for Grocery ERP
; Queue Worker Process Manager
; ============================================
;
; This configuration manages Laravel queue workers
; for processing background jobs in the Grocery ERP system.
;
; Installation:
; 1. Copy this file to /etc/supervisor/conf.d/
;    sudo cp groceryerp-worker.conf /etc/supervisor/conf.d/
;
; 2. Update supervisor configuration
;    sudo supervisorctl reread
;    sudo supervisorctl update
;
; 3. Start workers
;    sudo supervisorctl start groceryerp-worker:*
;
; 4. Check status
;    sudo supervisorctl status
;
; ============================================

[program:groceryerp-worker]
; Process name pattern
process_name=%(program_name)s_%(process_num)02d

; Command to run (update path if needed)
command=php /var/www/groceryerp/artisan queue:work redis --sleep=3 --tries=3 --max-time=3600 --timeout=300

; Auto-start on system boot
autostart=true

; Auto-restart if process crashes
autorestart=true

; Stop the whole process group
stopasgroup=true

; Kill the whole process group
killasgroup=true

; User to run the process as
user=www-data

; Number of worker processes to run
; Adjust based on your workload:
; - Light workload (< 100 jobs/day): 1-2 processes
; - Medium workload (100-1000 jobs/day): 2-4 processes
; - Heavy workload (> 1000 jobs/day): 4-8 processes
numprocs=2

; Redirect stderr to stdout
redirect_stderr=true

; Log file location
stdout_logfile=/var/www/groceryerp/storage/logs/worker.log

; Maximum log file size before rotation
stdout_logfile_maxbytes=50MB

; Number of log file backups to keep
stdout_logfile_backups=10

; Time to wait for graceful shutdown before killing
; Set to match max-time parameter (3600 seconds = 1 hour)
stopwaitsecs=3600

; Priority (lower number = higher priority)
priority=999

; ============================================
; Queue Worker Command Parameters Explained:
; ============================================
;
; --sleep=3
;   Number of seconds to sleep when no job is available
;   Lower = more responsive, higher = less CPU usage
;
; --tries=3
;   Number of times to attempt a job before failing
;   Failed jobs go to failed_jobs table
;
; --max-time=3600
;   Maximum seconds a worker should run before restarting
;   Prevents memory leaks (3600 = 1 hour)
;
; --timeout=300
;   Maximum seconds a single job can run
;   Jobs exceeding this will be killed (300 = 5 minutes)
;
; ============================================

; ============================================
; Additional Configurations (Optional)
; ============================================

; Environment variables (if needed)
;environment=
;    APP_ENV="production",
;    APP_DEBUG="false"

; Email notifications on worker crashes (requires sendmail)
;[eventlistener:crashmail]
;command=/path/to/crashmail.py
;events=PROCESS_STATE_EXITED
